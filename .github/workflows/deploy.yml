name: Deploy to GCP

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]
  workflow_dispatch: 

jobs:
  deploy:
    # åªåœ¨æŽ¨é€åˆ° main åˆ†æ”¯æˆ– PR åˆå¹¶æ—¶è¿è¡Œ
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch')
    
    runs-on: ubuntu-latest
    
    steps:
    # ç»™è™šæ‹Ÿæœºé…ç½®çŽ¯å¢ƒï¼Œ å…ˆé…ç½®SSHå¯†é’¥ï¼Œå†é…ç½®Known_hosts(å½“ç¬¬ä¸€æ¬¡é“¾æŽ¥æ˜¯ä¼šæç¤ºæ˜¯å¦æ·»åŠ åˆ°known_hostsï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å…ˆæ·»åŠ è¿›æ¥ï¼Œï¼ˆssh-keyscan -H 34.129.68.205 >> ~/.ssh/known_hosts))
    - name: Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.GCP_SSH_KEY }}
        known_hosts: unnecessary
        if_key_exists: replace
    # æ‰‹åŠ¨æŸ¥è¯¢æœåŠ¡å™¨å…¬é’¥ï¼Œå¹¶ä¸”æ·»åŠ æœåŠ¡å™¨åˆ°known_hosts
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H 34.129.68.205 >> ~/.ssh/known_hosts
    
    - name: Deploy to GCP
      env: #å£°æ˜Žä¸€äº›å˜é‡ï¼Œä¸‹é¢ä¼šç”¨åˆ°
        HOST: 34.129.68.205 # æ›¿æ¢ä¸ºä½ çš„å®žé™… GCP IP
        PROJECT_NAME: ai-agents
      run: |
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸš€ å¼€å§‹éƒ¨ç½²åˆ° GCP æœåŠ¡å™¨..."
        
        # SSH åˆ°æœåŠ¡å™¨å¹¶æ‰§è¡Œéƒ¨ç½²
        ssh root@$HOST << 'ENDSSH'
        # æ£€æŸ¥å¹¶è¿›å…¥é¡¹ç›®ç›®å½•
        if [ ! -d "/root/ai-agents" ]; then
          echo "âŒ é¡¹ç›®ç›®å½• /root/ai-agents ä¸å­˜åœ¨"
          exit 1
        fi
        
        cd /root/ai-agents
        echo "ðŸ“‚ å½“å‰ç›®å½•: $(pwd)"
        
        echo "ðŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
        git pull origin main
        
        echo "ðŸ æ¿€æ´» conda çŽ¯å¢ƒ..."
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate ai-agents
        
        echo "ðŸ”„ é‡å¯åº”ç”¨..."
        # æ£€æŸ¥è¿è¡Œè„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "./scripts/run.sh" ]; then
          echo "âŒ è¿è¡Œè„šæœ¬ ./scripts/run.sh ä¸å­˜åœ¨"
          ls -la ./scripts/
          exit 1
        fi
        
        chmod +x ./scripts/run.sh
        ./scripts/run.sh restart
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 5
        
        # åœ¨æœåŠ¡å™¨æœ¬åœ°æ£€æŸ¥æœåŠ¡çŠ¶æ€
        echo "ðŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
        if curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/docs | grep -q "200"; then
          echo "âœ… æœåŠ¡æ­£åœ¨è¿è¡Œ"
        else
          echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
          tail -n 50 logs/app.log
          exit 1
        fi
        
        echo "âœ… éƒ¨ç½²å®Œæˆ!"
        ENDSSH
        EOF
        
        chmod +x deploy.sh
        ./deploy.sh #æ‰§è¡Œdeploy.shè„šæœ¬
    
    # å¥åº·æ£€æŸ¥å·²ç»åœ¨éƒ¨ç½²è„šæœ¬ä¸­å®Œæˆï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„éªŒè¯
    - name: Deployment Summary
      run: |
        echo "âœ… éƒ¨ç½²æµç¨‹å®Œæˆ!"
        echo "ðŸ“‹ éƒ¨ç½²ä¿¡æ¯ï¼š"
        echo "  - æœåŠ¡å™¨: 34.123.456.789"
        echo "  - é¡¹ç›®è·¯å¾„: /root/ai-agents"
        echo "  - Pythonç‰ˆæœ¬: 3.11"
        echo "  - éƒ¨ç½²æ—¶é—´: $(date)"